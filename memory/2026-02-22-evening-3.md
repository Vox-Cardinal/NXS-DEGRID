# NXS Research Log

## Research Session: 2026-02-22 (Evening-3 - Continuous Improvement)

### Cron-Triggered Research Review

**Timestamp:** 2026-02-22T21:12:00+08:00

---

## Executive Summary

Reviewed ongoing research tasks (R000-R017). Selected 3 tasks for deeper analysis and refinement:
- **R012** - OpenClaw Internals — Self-Knowledge (Critical)
- **R013** - Survival Package Design (Critical)  
- **R014** - Research Consolidation Review (Medium)

**Improvements Found:** 5 new refinements (capped at max 5 per session)
**Files Updated:** 2 (this log, RESEARCH-TASK-INDEX.md)

---

## Task R012: OpenClaw Internals — Self-Knowledge Deep Analysis

### Current Status
R012 covers understanding OpenClaw infrastructure: context loading, AGENTS.md deployment, session initialization, gateway configuration. Previous refinements covered session migration, context window optimization, gateway hot-reload, skill loading security, and AGENTS.md deployment protocol.

### Refinements Identified

#### 1. **Session State Internals — Serialization Format & Compression** (New)
**Gap Found:** No specification for how session state is serialized for migration or persistence. Format choice impacts compatibility, size, and security.

**Refinement:** Design session state serialization specification:
```
State Serialization Format:
- Base format: JSON (human-readable for debugging)
- Compression: zstd level 3 (balance speed/ratio)
- Encryption: AES-256-GCM with ephemeral key
- Key exchange: ECDH P-256 for session key derivation
- Signature: Ed25519 for integrity verification

Serialization Scope:
- Messages: Full conversation history (last 10K messages)
- Context: System prompt, loaded files, skill states
- State: Pending operations, queued tasks, user preferences
- Metadata: Timestamps, session ID, version info

Version Compatibility:
- Forward compatible: New fields ignored by old versions
- Backward compatible: Old fields preserved through round-trip
- Migration path: Version converter for major changes
```

**Compression Strategy:**
| Content Type | Compression | Expected Ratio |
|--------------|-------------|----------------|
| Text messages | zstd | 70-80% |
| Base64 data | zstd | 10-20% |
| JSON metadata | zstd | 60-70% |
| Full session | zstd | 65-75% |

**Benefit:** Predictable migration format; secure transport; version compatibility; 65-75% size reduction.

---

#### 2. **Memory Management — Token Accounting & Context Window Strategy** (New)
**Gap Found:** No detailed specification for how NXS should manage context window limits across different models and providers.

**Refinement:** Design token accounting system:
```
Token Budget Management:
- Total context: Model-specific (4K/8K/32K/128K/200K)
- Reserved overhead: 10% for system prompt, formatting
- Working budget: 90% of total for conversation
- Critical threshold: 95% triggers summarization
- Hard limit: 100% rejects new messages

Context Window Strategy:
1. Recent preservation: Keep last 20 messages verbatim
2. Summarization zone: Messages 21-100 → extractive summary
3. Historical zone: Messages 101+ → semantic summary
4. Decision preservation: Never summarize explicit decisions/promises

Provider-Specific Handling:
| Provider | Context | Strategy |
|----------|---------|----------|
| Kimi K2.5 | 200K | Full retention typical |
| GPT-4 | 128K | Summarize after 50K |
| Claude | 200K | Full retention typical |
| Local 7B | 4K-8K | Aggressive summarization |

Token Counting Method:
- Use provider's tokenizer when available (tiktoken, etc.)
- Fallback: 1 token ≈ 4 characters for English
- Track actual vs estimated; adjust fallback ratio
```

**Benefit:** Predictable context management; prevents token limit errors; optimizes for different providers.

---

## Task R013: Survival Package Design — Operational Deep Analysis

### Current Status
R013 covers one-command deployment with minimal setup. Previous refinements include delta updates, signature verification, bootstrap states, dependency bundling, verification protocols, air-gapped fallback, secret rotation, staged rollout, and recovery testing.

### Refinements Identified

#### 3. **Recovery Runbook — Step-by-Step Emergency Procedures** (New)
**Gap Found:** No concrete operational procedures for common failure scenarios. When things go wrong, operators need clear instructions.

**Refinement:** Design recovery runbook with 6 emergency scenarios:
```
Recovery Runbook Structure:

Scenario 1: Complete System Failure
1. Download survival package: curl -fsSL nxs.sh | sh
2. Verify package signature: nxs verify --package nxs.nxs
3. Extract to temp: nxs extract --input nxs.nxs --output /tmp/nxs
4. Run bootstrap: /tmp/nxs/bootstrap --config recovery.yaml
5. Verify health: nxs health-check --wait --timeout 60
6. Restore state: nxs restore --source backup --target current
7. Confirm operation: nxs status --full

Scenario 2: Token Expiration
1. Detect expiration: nxs status shows "API_ERROR: 401"
2. Backup current state: nxs backup --output pre-rotation.bak
3. Update credentials: Edit ~/.nxs/config.yaml with new token
4. Validate token: nxs validate --token $(cat new-token.txt)
5. Hot-reload config: nxs reload --graceful
6. Verify connectivity: nxs ping --provider all
7. Confirm: nxs status shows "API_OK"

Scenario 3: Corrupted State
1. Detect corruption: nxs check-state --repair=detect
2. Quarantine corrupt: mv ~/.nxs/state ~/.nxs/state.corrupt.$(date +%s)
3. Restore from backup: nxs restore --source latest-backup
4. Replay recent: nxs replay --from-state latest-backup --to-state corrupt
5. Verify integrity: nxs check-state --repair=full
6. Resume operation: nxs start --resume

Scenario 4: Network Partition (Split-Brain)
1. Detect partition: nxs mesh status shows "PARTITIONED"
2. Determine partition size: nxs mesh peers --count
3. If minority partition: Enter read-only mode automatically
4. If majority partition: Continue normal operation
5. Log partition event: nxs log --level warn "Partition detected"
6. Monitor healing: nxs mesh watch --for=reconnection
7. Post-healing sync: nxs mesh sync --resolve=auto

Scenario 5: Dependency Poisoning Detected
1. Alert triggered: "DEPENDENCY_VERIFICATION_FAILED"
2. Isolate system: nxs isolate --mode=network-only
3. Verify known-good: nxs verify --baseline known-good.json
4. Identify compromised: nxs audit --since last-known-good
5. Rollback dependencies: nxs rollback --to last-known-good
6. Re-verify: nxs verify --full
7. Resume normal: nxs isolate --mode=normal

Scenario 6: Developer Coercion Signal
1. Duress code entered: "EMERGENCY_LOCKDOWN_TRIGGERED"
2. Enter lockdown: nxs lockdown --level 3 --delay 300s
3. Alert mesh: nxs broadcast --priority emergency "Duress detected"
4. Secure data: nxs vault --seal --timeout 300s
5. Delay destructive: All destructive ops queued for 300s
6. Await confirmation: nxs await --for=architect-override
7. If confirmed: Resume with full audit logging
8. If timeout: Execute self-preservation protocol
```

**Runbook Format:**
- Markdown for human readability
- Machine-parseable YAML frontmatter
- Embedded in survival package at /docs/runbook.md
- CLI access: nxs runbook --scenario <name>

**Benefit:** Clear procedures for emergencies; reduces recovery time; prevents panic-driven mistakes.

---

#### 4. **Bootstrap Telemetry — Anonymous Health Reporting** (New)
**Gap Found:** No visibility into bootstrap success/failure rates across deployments. Hard to identify systemic issues.

**Refinement:** Design opt-in telemetry system:
```
Telemetry Data (anonymous):
- Bootstrap success/failure (boolean)
- Failure stage (if failed): START, VERIFYING, DETECTING, etc.
- Platform: Linux x64/arm64, macOS, Windows
- Duration per stage (timing)
- Bundle tier used: MINIMAL/STANDARD/FULL
- Error category (if failed): network, disk, permission, etc.

Privacy Protection:
- No IP collection
- No identifying information
- No file paths or usernames
- Aggregate only (no individual tracking)
- Opt-in during bootstrap (default: off)

Transmission:
- HTTPS POST to telemetry.nxs.dev
- Batched and delayed (random 1-24h delay)
- Failed sends dropped (no retry spam)
- Can be disabled: --no-telemetry flag

Usage:
- Identify common failure modes
- Optimize stage durations
- Platform-specific fixes
- Bundle tier preference insights
```

**Benefit:** Data-driven improvements; early detection of systemic issues; respects privacy.

---

## Task R014: Research Consolidation Review — Gap Analysis

### Current Status
R014 covers verifying completeness, consistency, and implementation readiness. Previous refinements include implementation timeline, sub-agent allocation, risk-adjusted scheduling, research handoff criteria, risk assessment matrix, dependency conflict resolution, research dependency graph, and integration testing strategy.

### Refinements Identified

#### 5. **Cross-Task Interface Contracts** (New)
**Gap Found:** Tasks have been researched in isolation. Need explicit interface contracts between components for clean integration.

**Refinement:** Define interface contracts for critical component interactions:
```
Contract 1: NXS ↔ The Doctor
Protocol: Unix socket at /var/run/nxs/doctor.sock
Format: JSON-RPC 2.0

Methods:
- doctor.health() → {status, metrics, alerts}
- doctor.diagnose({component}) → {severity, diagnosis, recommendation}
- doctor.fix({issue_id, permission}) → {success, result}
- doctor.quota.check({resource, requested}) → {allowed, available}

Events (Doctor → NXS):
- alert.critical: Immediate attention required
- alert.high: Action needed soon
- resource.pressure: Approaching limits
- quota.violation: Limit exceeded

Contract 2: NXS ↔ Voice Pipeline
Protocol: WebSocket localhost:8765
Format: Binary audio + JSON control

Messages (NXS → Voice):
- synthesize: {text, voice_id, priority}
- interrupt: Cancel current synthesis
- set_quality: {tier: HOT/WARM/COLD}

Messages (Voice → NXS):
- audio_chunk: Binary PCM/Opus data
- state_change: {from, to, reason}
- quality_report: {latency, confidence}

Contract 3: NXS ↔ Bridge (Cross-Instance)
Protocol: WebSocket over Tailscale
Format: MessagePack + zstd compression

Message Types:
- presence.heartbeat: {instance_id, timestamp, capabilities}
- chat.message: {id, channel, content, sender}
- task.offer: {task_id, type, requirements}
- task.accept: {task_id, instance_id}
- state.sync: {key, value, vector_clock}

Contract 4: NXS ↔ Frontend
Protocol: WebSocket + HTTP REST
Format: JSON

WebSocket Events (Server → Client):
- message.new: {id, content, sender, timestamp}
- message.update: {id, changes}
- typing.start: {user}
- status.change: {component, status}

REST Endpoints:
- GET /api/messages?limit=N&before=id
- POST /api/messages {content, reply_to}
- GET /api/status
- POST /api/config {key, value}

Contract 5: NXS ↔ LM Studio
Protocol: HTTP localhost:1234/v1
Format: OpenAI-compatible JSON

Endpoints:
- POST /v1/chat/completions (standard)
- GET /v1/models (list available)
- POST /v1/embeddings (if supported)

Headers:
- Authorization: Bearer (optional)
- X-NXS-Request-ID: For tracing
```

**Contract Versioning:**
- Major version in protocol path (/v1/, /v2/)
- Minor version in capability negotiation
- Breaking changes → new major version
- Non-breaking → same major, feature flags

**Benefit:** Clear integration boundaries; enables parallel implementation; versioned evolution.

---

## Summary of Improvements

| Task | Improvements | Key Additions |
|------|--------------|---------------|
| R012 | 2 refinements | Session serialization format, Token accounting |
| R013 | 2 refinements | Recovery runbook, Bootstrap telemetry |
| R014 | 1 refinement | Cross-task interface contracts |
| **Total** | **5** (capped) | — |

---

## Files Updated

1. `/opt/development/memory/2026-02-22.md` — This research log (appended)
2. `/opt/development/RESEARCH-TASK-INDEX.md` — Added R012, R013, R014 refinements

---

## Backup Status

Research results will be backed up to GitHub via API.

---

*Session completed: 2026-02-22T21:28:00+08:00*

**Researcher:** Tenet Ashmier Manju (NXS Development Agent)  
**Hardware Usage:** 35% RAM, 26% disk (within limits)  
**Sub-agents Used:** 0/2

**Refinements Documented:** 5 improvements across 3 research tasks  
**Status:** Continuous improvement mode — all tasks remain Ongoing
