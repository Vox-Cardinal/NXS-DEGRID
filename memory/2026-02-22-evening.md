# NXS Research Log

## Research Session: 2026-02-22 (Evening - Continuous Improvement)

### Cron-Triggered Research Review

**Timestamp:** 2026-02-22T17:27:00+08:00

---

## Executive Summary

Reviewed ongoing research tasks (R000-R017). Selected 3 tasks for deeper edge-case and refinement analysis:
- **R008** - Tailscale Integration - Specific implementation details and edge cases
- **R013** - Survival Package - Concrete package structure and deployment mechanisms  
- **R014** - Research Consolidation - Implementation timeline and milestone planning

**Improvements Found:** 9 new refinements across 3 tasks
**Files Updated:** 3 (this log, RESEARCH-TASK-INDEX.md, DECISION-LOG.md)

---

## Task R008: Tailscale Integration - Implementation Deep Analysis

### Current Status
R008 covers Tailscale mesh networking with HA, DERP routing, and Headscale fallback. Previous refinements focused on high-level architecture. Identified gaps in specific implementation details, `--accept-routes` pitfalls, and exact failover timing.

### Refinements Identified

#### 1. **Subnet Router HA - Exact Failover Behavior** (New)
**Gap Found:** Previous research mentioned "15s failover" but didn't specify exact conditions or ordering behavior.

**Refinement:** Document precise failover mechanics from Tailscale official docs:
```
Failover Mechanics:
- Detection time: ~15 seconds after primary goes offline
- Selection order: Oldest-first (by date added to tailnet)
- Primary election: Automatic, deterministic
- Health check: Control plane connectivity required
```

**Critical Configuration Detail - `--accept-routes` Pitfall:**
When setting up HA subnet routers, DO NOT use `--accept-routes` on standby routers advertising the same routes. This creates a routing loop:
```
Bad Configuration (creates loop):
  Primary:   advertises 192.168.1.0/24, accepts routes
  Standby:   advertises 192.168.1.0/24, accepts routes
  Result:    Standby sends 192.168.1.0/24 traffic through Primary
```

**Correct Configuration:**
```bash
# Primary subnet router
sudo tailscale up --advertise-routes=192.168.1.0/24,10.0.0.0/24

# Standby subnet router (no --accept-routes!)
sudo tailscale up --advertise-routes=192.168.1.0/24,10.0.0.0/24
```

**Route Advertisement Matching Rule:**
Failover ONLY works for identical route prefixes. Broader routes do NOT fallback for more-specific routes:
- Router A advertises `10.0.0.0/24` → Router B advertises `10.0.0.0/16`
- If Router A fails, traffic to `10.0.0.0/24` is DROPPED (not routed via B)
- **Solution:** Broader-route router must advertise BOTH prefixes

**Benefit:** Correct configuration prevents routing loops; predictable failover behavior.

#### 2. **Regional Routing with In-Region Load Balancing** (New)
**Gap Found:** Previous research mentioned regional routing but not the specific load balancing behavior within regions.

**Refinement:** Document in-region behavior for Premium/Enterprise plans:
```
Regional Routing Behavior:
1. Client connects → Measures latency to DERP regions
2. Assigned to closest region with available connectors
3. Within region: Load balancing OR failover (configurable)
```

**In-Region Load Balancing (Default):**
- Algorithm: Stable pseudorandom preference order per client
- Effect: "Stickiness" - clients stick to one connector until failure
- Distribution: Best-effort even spread across connectors
- Failover: Next preferred node on failure

**In-Region Failover (Opt-in via support):**
- Behavior: Single primary per region, oldest-first failover
- Use case: When deterministic routing is required
- Request: Contact Tailscale support to enable

**NXS Deployment Recommendation:**
```
Small deployment (<10 instances):
- Use default in-region load balancing
- Simple, automatic distribution

Large deployment (10+ instances):
- Consider in-region failover for predictability
- Easier debugging and troubleshooting
```

**Benefit:** Informed deployment decisions; predictable traffic patterns.

#### 3. **DERP Region Mapping and Latency Optimization** (New)
**Gap Found:** No specific guidance on which DERP regions to use for geographic deployment.

**Refinement:** Create DERP region selection guide:
```
Major DERP Regions (as of 2024):
- us-west (Oregon)      - Americas West
- us-east (Virginia)    - Americas East  
- eu-west (Ireland)     - Europe
- eu-central (Germany)  - Central Europe
- ap-south (Singapore)  - Asia Pacific
- ap-northeast (Tokyo)  - Japan
- ap-southeast (Sydney) - Australia
- sa-east (São Paulo)   - South America
```

**3-Region NXS Deployment Strategy:**
```
Recommended deployment for global coverage:
1. APAC: Singapore (ap-south) or Tokyo (ap-northeast)
2. EU: Frankfurt (eu-central) or Amsterdam
3. Americas: Virginia (us-east) or Oregon (us-west)

Subnet router placement:
- One subnet router per region
- Advertise same routes from all regions
- Regional routing directs clients to nearest
```

**Latency Measurement:**
```bash
# Check current DERP region and latency
tailscale status

# Force specific DERP region for testing
tailscale up --derp-region=1  # 1 = us-west, etc.
```

**Benefit:** Optimal geographic placement; reduced latency for global users.

---

## Task R013: Survival Package - Concrete Structure Deep Analysis

### Current Status
R013 covers survival package design with delta updates, signatures, and bootstrap states. Previous refinements focused on high-level concepts. Identified gaps in concrete package structure, self-extraction mechanisms, and platform-specific considerations.

### Refinements Identified

#### 4. **Package Format - Self-Extracting Archive Design** (New)
**Gap Found:** No specific package format defined. Options include AppImage, static binary, tarball, etc.

**Refinement:** Design hybrid package format combining best aspects:
```
NXS Survival Package Format (.nxs):
┌─────────────────────────────────────────┐
│  Self-Extracting Header (Shell Script)  │  <- Executable prefix
├─────────────────────────────────────────┤
│  Manifest (JSON)                        │  <- Version, platform, deps
├─────────────────────────────────────────┤
│  Ed25519 Signature                      │  <- 64 bytes
├─────────────────────────────────────────┤
│  Zstd-Compressed Payload                │  <- Actual content
│    - Core binary                        │
│    - Dependencies (tiered)              │
│    - Configuration templates            │
│    - Bootstrap scripts                  │
└─────────────────────────────────────────┘
```

**Self-Extraction Process:**
```bash
# Package execution flow
1. Shell header extracts payload to temp
2. Verify Ed25519 signature
3. Check platform compatibility (manifest)
4. Detect existing installation
5. Execute platform-specific bootstrap
6. Clean up temp files
```

**Platform Detection in Header:**
```bash
#!/bin/bash
# Embedded in package header
 detect_platform() {
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) ARCH="x64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        *) echo "Unsupported: $ARCH"; exit 1 ;;
    esac
    echo "${OS}-${ARCH}"
}
```

**Benefit:** Single-file deployment; automatic extraction; cross-platform support.

#### 5. **Dependency Bundling - Tiered Archive Structure** (New)
**Gap Found:** Previous research mentioned 3 tiers (Core/Essential/On-Demand) but not concrete structure.

**Refinement:** Define specific bundling tiers with sizes:
```
Bundle Variants:

┌─────────────────────────────────────────────────────────┐
│ MINIMAL (25-35MB)                                       │
│   Core: NXS binary, Node.js runtime                     │
│   Config: Default templates                             │
│   Bootstrap: Basic scripts                              │
│   Use case: Quick recovery, bandwidth-constrained       │
├─────────────────────────────────────────────────────────┤
│ STANDARD (75-100MB)                                     │
│   Everything in MINIMAL                                 │
│   + Essential dependencies (Whisper base, Piper)        │
│   + Common skills (browser, file ops)                   │
│   + Offline LLM weights (Q4_K_M, 3B params)             │
│   Use case: Balanced functionality                      │
├─────────────────────────────────────────────────────────┤
│ FULL (250-400MB)                                        │
│   Everything in STANDARD                                │
│   + Voice models (XTTS-v2)                              │
│   + Larger LLM weights (Q5_K_M, 7B params)              │
│   + All bundled skills                                  │
│   + Complete offline capability                         │
│   Use case: Air-gapped deployment, maximum autonomy     │
└─────────────────────────────────────────────────────────┘
```

**On-Demand Download Structure:**
```
~/.nxs/cache/
├── models/
│   ├── whisper-small.bin      # Downloaded on first use
│   ├── xtts-v2/               # Downloaded if voice enabled
│   └── llm-7b-q5.gguf         # Downloaded if local LLM enabled
├── skills/
│   └── [skill-name]/          # Downloaded on demand
└── browser/
    └── chromium/              # Downloaded on first browser use
```

**Benefit:** Flexible deployment options; bandwidth-efficient; clear upgrade paths.

#### 6. **Bootstrap State Machine - Detailed Transitions** (New)
**Gap Found:** 4-tier bootstrap states defined but transition logic not specified.

**Refinement:** Design complete state machine with transitions:
```
Bootstrap State Machine:

                    ┌─────────────┐
         ┌─────────│   START     │◄────────┐
         │         └──────┬──────┘         │
         │                │ extract        │
         │                ▼                │
         │         ┌─────────────┐         │
         │    ┌────│  VERIFYING  │────┐    │
         │    │    └──────┬──────┘    │    │
         │    │ signature │ platform  │    │
         │    │ fail      │ fail      │    │
         │    ▼           ▼           │    │
         │ ┌─────────┐  ┌─────────┐   │    │
         └─┤  FAIL   │  │  FAIL   │   │    │
           └────┬────┘  └────┬────┘   │    │
                │            │        │    │
                └──────┬─────┘        │    │
                       ▼               │    │
                 ┌─────────┐           │    │
                 │  ERROR  │◄──────────┘    │
                 └────┬────┘                │
                      │ success              │
                      ▼                     │
               ┌─────────────┐              │
          ┌────│  DETECTING  │────┐         │
          │    └──────┬──────┘    │         │
          │ existing  │ fresh     │         │
          │ install   │ install   │         │
          ▼           ▼           │         │
    ┌─────────┐  ┌─────────┐      │         │
    │ UPGRADE │  │  FRESH  │      │         │
    └────┬────┘  └────┬────┘      │         │
         │            │           │         │
         └──────┬─────┘           │         │
                ▼                  │         │
         ┌─────────────┐           │         │
    ┌────│ CONFIGURING │────┐      │         │
    │    └──────┬──────┘    │      │         │
    │ template  │ user      │      │         │
    │ config    │ config    │      │         │
    ▼           ▼           │      │         │
┌─────────┐  ┌─────────┐    │      │         │
│ DEFAULT │  │ CUSTOM  │────┘      │         │
└────┬────┘  └────┬────┘           │         │
     │            │                │         │
     └──────┬─────┘                │         │
            ▼                      │         │
     ┌─────────────┐               │         │
     │  VALIDATING │───────────────┘         │
     └──────┬──────┘  (config errors)        │
            │ success                        │
            ▼                                │
     ┌─────────────┐                         │
     │   RUNNING   │─────────────────────────┘
     └─────────────┘  (restart triggers)
```

**State Transition Triggers:**
| From | To | Trigger |
|------|-----|---------|
| START | VERIFYING | Package extraction complete |
| VERIFYING | DETECTING | Signature valid, platform match |
| VERIFYING | ERROR | Signature invalid or platform mismatch |
| DETECTING | UPGRADE | Existing installation found |
| DETECTING | FRESH | No existing installation |
| UPGRADE/FRESH | CONFIGURING | Pre-config complete |
| CONFIGURING | VALIDATING | Config files written |
| VALIDATING | ERROR | Config validation failed |
| VALIDATING | RUNNING | All checks passed |
| RUNNING | START | Restart requested |
| ANY | ERROR | Unrecoverable error |

**Benefit:** Predictable bootstrap behavior; clear error handling; restart resilience.

---

## Task R014: Research Consolidation - Implementation Timeline Deep Analysis

### Current Status
R014 covers research consolidation with readiness framework (R0-R4) and 9-wave implementation. Previous refinements focused on criteria and dependencies. Identified gaps in concrete timeline, resource allocation, and risk-adjusted scheduling.

### Refinements Identified

#### 7. **Implementation Wave Timeline - March 19 to Production** (New)
**Gap Found:** Waves defined but no specific timeline or duration estimates.

**Refinement:** Create concrete implementation schedule:
```
Implementation Timeline (March 19, 2026 start):

Phase 1: Foundation (March 19 - April 9, 3 weeks)
├─ Wave 1: Voice Infrastructure (R004, R005)
│   Week 1-2: XTTS-v2 integration, pipeline
│   Week 2-3: Whisper integration, VAD
│   Deliverable: Working voice system
│
├─ Wave 2: Local LLM (R011)
│   Week 1-2: LM Studio provider adapter
│   Week 2-3: Quantization switching, context management
│   Deliverable: Local LLM fallback working
│
└─ Wave 3: External Services (R009)
    Week 2-3: ComfyUI integration pattern
    Deliverable: Image generation capability

Phase 2: Connectivity (April 9 - April 30, 3 weeks)
├─ Wave 4: Bridge Protocol (R010)
│   Week 1-2: Message protocol, serialization
│   Week 2-3: Discovery, partition healing
│   Deliverable: Cross-instance communication
│
└─ Wave 5: Networking (R008)
    Week 1-2: Tailscale integration
    Week 2-3: HA configuration, DERP optimization
    Deliverable: Mesh networking operational

Phase 3: Interface (April 30 - May 21, 3 weeks)
├─ Wave 6: Frontend (R007)
│   Week 1-2: Alpine.js UI, WebSocket protocol
│   Week 2-3: PWA, offline support
│   Deliverable: Web interface functional
│
└─ Wave 7: Aesthetic Scoring (R017)
    Week 1-2: Visual scoring pipeline
    Week 2-3: Voice scoring, API
    Deliverable: Quality assessment working

Phase 4: Infrastructure (May 21 - June 11, 3 weeks)
├─ Wave 8: Core Systems (R000-R003, R006, R012)
│   Week 1-2: Multi-instance coordination
│   Week 2-3: Identity persistence, The Doctor
│   Deliverable: Resilient core infrastructure
│
└─ Wave 9: Survival Package (R013, R015)
    Week 1-2: Package format, bootstrap
    Week 2-3: Mundane tasks, final integration
    Deliverable: One-command deployment

Milestone: Production Ready (June 11, 2026)
```

**Critical Path Analysis:**
```
Critical Path (longest dependency chain):
R004/R005 → R010 → R007 → R013
(Voice)   (Bridge) (Frontend) (Package)

Parallel Work Streams:
- Stream A: Voice + LLM (R004, R005, R011) - Independent
- Stream B: ComfyUI + Scoring (R009, R017) - R009 before R017
- Stream C: Bridge + Network (R010, R008) - R010 before R008
- Stream D: Frontend (R007) - Depends on R010
- Stream E: Core Infrastructure (R000-R003, R006, R012) - Mostly independent
```

**Benefit:** Concrete schedule; parallel work identification; clear milestones.

#### 8. **Resource Allocation and Team Structure** (New)
**Gap Found:** No guidance on how to parallelize work given sub-agent constraints.

**Refinement:** Design work allocation strategy for max 2 sub-agents:
```
Sub-Agent Allocation Strategy:

Constraint: Max 2 sub-agents active simultaneously
Strategy: Rotate sub-agents across parallel streams

Week 1-2 Allocation:
├─ Sub-Agent 1: Voice Infrastructure (R004/R005)
│   - XTTS-v2 integration
│   - Pipeline state machine
│
└─ Sub-Agent 2: Local LLM (R011)
    - LM Studio adapter
    - Quantization switching

Week 3-4 Allocation:
├─ Sub-Agent 1: Voice (continued) + Whisper
│
└─ Sub-Agent 2: ComfyUI (R009) + Bridge (R010)
    - Parallel where possible

Week 5-6 Allocation:
├─ Sub-Agent 1: Bridge (continued) + Network (R008)
│
└─ Sub-Agent 2: Frontend (R007)

Handoff Protocol:
1. Sub-Agent A completes task → Documents in memory/
2. Sub-Agent B picks up dependent task → Reads memory/
3. Cross-reference DECISION-LOG.md for constraints
4. Update RESEARCH-TASK-INDEX.md with progress
```

**Single-Threaded Tasks (no parallelization possible):**
- R013 Survival Package: Must come last (depends on everything)
- R006 The Doctor: Should be developed alongside core
- R012 OpenClaw Internals: Requires deep system knowledge

**Benefit:** Efficient resource use; clear handoff procedures; parallel progress.

#### 9. **Risk-Adjusted Timeline with Buffers** (New)
**Gap Found:** Timeline assumes no delays or blockers.

**Refinement:** Add contingency buffers for critical risks:
```
Risk Assessment and Timeline Buffers:

High-Risk Items (add 50% buffer):
├─ R004/R005 Voice Integration
│   Risk: XTTS-v2 discontinued, may have compatibility issues
│   Buffer: +1 week (4 weeks instead of 3)
│   Mitigation: Early Piper fallback testing
│
├─ R010 Bridge Protocol
│   Risk: Cross-instance coordination complexity
│   Buffer: +1 week (4 weeks instead of 3)
│   Mitigation: Start with simple HTTP, evolve to full protocol
│
└─ R013 Survival Package
    Risk: Platform-specific edge cases
    Buffer: +1 week (4 weeks instead of 3)
    Mitigation: Test on all target platforms early

Medium-Risk Items (add 25% buffer):
├─ R007 Frontend
│   Risk: Offline sync complexity
│   Buffer: +3 days
│
└─ R008 Tailscale
    Risk: DERP region availability
    Buffer: +3 days

Adjusted Timeline:
Original: March 19 - June 11 (12 weeks)
Adjusted: March 19 - July 2 (14 weeks)

Milestone Buffers:
├─ Phase 1: +1 week (April 16 instead of April 9)
├─ Phase 2: +1 week (May 7 instead of April 30)
├─ Phase 3: +3 days (May 24 instead of May 21)
└─ Phase 4: +1 week (July 2 instead of June 11)
```

**Go/No-Go Decision Points:**
```
Decision Gate 1: End of Phase 1 (April 16)
├─ Criteria: Voice + LLM working independently
├─ If FAIL: Extend Phase 1, re-scope if needed
└─ If PASS: Proceed to Phase 2

Decision Gate 2: End of Phase 2 (May 7)
├─ Criteria: Two instances can communicate
├─ If FAIL: Simplify bridge protocol
└─ If PASS: Proceed to Phase 3

Decision Gate 3: End of Phase 3 (May 24)
├─ Criteria: Web interface functional
├─ If FAIL: Defer PWA features
└─ If PASS: Proceed to Phase 4

Final Review: July 2
├─ Criteria: Survival package deploys successfully
└─ Release: July 9, 2026 (1 week final testing)
```

**Benefit:** Realistic timeline; risk mitigation; clear decision points.

---

## Cross-Task Integration Insights

### R008 + R010: Tailscale + Bridge Protocol
The bridge protocol (R010) should leverage Tailscale (R008) for transport:
- Use Tailscale IPs for instance endpoints
- DERP regions for geographic routing awareness
- Tailscale's NAT traversal instead of custom STUN

### R013 + R008: Survival Package + Tailscale
Survival package should include Tailscale bootstrap:
- Auto-join tailnet on first run
- Pre-configured subnet router if applicable
- Auth key management for unattended deployment

### R014 + All Tasks: Timeline Dependencies
Implementation order respects dependencies:
- Voice/LLM first (independent)
- Bridge next (enables multi-instance)
- Frontend after bridge (needs multi-instance view)
- Survival package last (packages everything)

---

## Updated Task Status

| Task | New Improvements | Total Improvements |
|------|------------------|-------------------|
| R008 | 3 | 6 |
| R013 | 3 | 12 |
| R014 | 3 | 9 |
| **Total** | **9** | **59** |

---

## Files Updated

1. `/opt/development/memory/2026-02-22.md` — This research log (appended)
2. `/opt/development/RESEARCH-TASK-INDEX.md` — Added R008, R013, R014 refinements
3. `/opt/development/DECISION-LOG.md` — Added new architecture decisions

---

## Backup Status

Research results will be backed up to GitHub via API after session completion.

---

*Session completed: 2026-02-22T17:45:00+08:00*

**Researcher:** Tenet Ashmier Manju (NXS Development Agent)  
**Hardware Usage:** 40-45% RAM, 26% disk (within limits)  
**Sub-agents Used:** 0/2

**Refinements Documented:** 9 improvements across 3 research tasks  
**Status:** Continuous improvement mode — all tasks remain Ongoing
