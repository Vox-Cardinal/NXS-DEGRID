# NXS Research Log

## Research Session: 2026-02-21 03:33 AM (Cron Auto-Run)

### Task R008: Tailscale Integration - COMPLETED

**Timestamp Completed:** 2026-02-21T03:50:00+08:00

---

## R008 Final Findings: Tailscale Mesh Networking for NXS

### Executive Summary

Tailscale provides the ideal networking foundation for NXS's distributed survival architecture. It creates an encrypted mesh network (tailnet) using WireGuard, enabling NXS instances to communicate securely across any network topology without port forwarding or complex firewall rules.

**Key Finding:** Tailscale is not just a VPN—it's a zero-config mesh network that enables NXS instances to form a resilient, self-healing communication fabric. Combined with Headscale (self-hosted control plane), NXS gains complete independence from external infrastructure.

---

### Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         NXS TAILNET MESH                                    │
│                                                                             │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐               │
│   │  NXS Node A  │◄───►│  NXS Node B  │◄───►│  NXS Node C  │               │
│   │  (VPS-1)     │     │  (VPS-2)     │     │  (Home)      │               │
│   │  100.64.1.1  │     │  100.64.1.2  │     │  100.64.1.3  │               │
│   └──────┬───────┘     └──────┬───────┘     └──────┬───────┘               │
│          │                    │                    │                        │
│          └────────────────────┼────────────────────┘                        │
│                               │                                             │
│                    ┌──────────┴──────────┐                                  │
│                    │   Subnet Router     │                                  │
│                    │   (Legacy Access)   │                                  │
│                    └──────────┬──────────┘                                  │
│                               │                                             │
│                    ┌──────────┴──────────┐                                  │
│                    │   Exit Node         │                                  │
│                    │   (Internet Gateway)│                                  │
│                    └─────────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────────┘

Control Plane Options:
┌─────────────────────┐    ┌─────────────────────┐
│  Tailscale Cloud    │    │   Headscale         │
│  (Managed)          │    │   (Self-hosted)     │
│  • Easy setup       │    │   • Full control    │
│  • Free for personal│    │   • Data sovereignty│
│  • Depends on vendor│    │   • Requires server │
└─────────────────────┘    └─────────────────────┘
```

---

### Core Concepts

| Concept | Description | NXS Relevance |
|---------|-------------|---------------|
| **Tailnet** | Private mesh network of Tailscale nodes | NXS instances form a private, encrypted network |
| **Node** | Device running Tailscale client | Each NXS instance is a node |
| **Control Plane** | Coordinates connections, distributes keys | Can be Tailscale cloud or self-hosted Headscale |
| **DERP** | Relay server for NAT traversal | Fallback when direct connections fail |
| **Subnet Router** | Gateway to non-Tailscale subnets | Access legacy devices without Tailscale client |
| **Exit Node** | Routes internet traffic | Secure internet access from any location |
| **ACL** | Access Control Lists | Fine-grained permissions between nodes |
| **MagicDNS** | Automatic DNS for tailnet | Access nodes by name, not just IP |

---

### Tailscale vs Headscale Decision Matrix

| Factor | Tailscale Cloud | Headscale (Self-hosted) | Recommendation |
|--------|-----------------|------------------------|----------------|
| **Setup complexity** | Minimal | Moderate | Cloud for quick start |
| **Data control** | Vendor-hosted | Self-hosted | Headscale for sovereignty |
| **Cost** | Free (personal) | Server cost only | Both viable |
| **Reliability** | 99.9% SLA | Depends on your infra | Cloud more reliable |
| **Independence** | Low | High | Headscale for survival |
| **Features** | All features | Most features (no Funnel) | Cloud has edge |
| **Vendor lock-in** | Yes | No | Headscale for autonomy |

**NXS Recommendation:** Start with Tailscale Cloud for immediate functionality, migrate to Headscale for long-term survival independence.

---

### Headscale Self-Hosting Guide

**Docker Compose Configuration:**
```yaml
services:
  headscale:
    container_name: headscale
    image: headscale/headscale:v0.26.0
    restart: unless-stopped
    ports:
      - '8080:8080'  # Control plane
      - '9090:9090'  # Metrics
    volumes:
      - '/data/headscale/config:/etc/headscale'
      - '/data/headscale/data:/var/lib/headscale'
    environment:
      TZ: 'Asia/Shanghai'
    command: serve
```

**Required Configuration (config.yaml):**
```yaml
server_url: https://headscale.yourdomain.com
listen_addr: 0.0.0.0:8080
metrics_listen_addr: 0.0.0.0:9090

database:
  sqlite:
    write_ahead_log: true

policy:
  mode: database  # Use Headplane for GUI management

dns:
  magic_dns: true
  base_domain: nxs.ts.net
  override_local_dns: true
  nameservers:
    global:
      - 1.1.1.1
      - 8.8.8.8
```

**Network Requirements:**
| Protocol | Port | Purpose |
|----------|------|---------|
| TCP | 80 | HTTP redirect |
| TCP | 443 | HTTPS control plane |
| TCP | 8080 | Headscale API |
| UDP | 3478 | STUN (NAT traversal) |
| UDP | 41641 | WireGuard direct connections |

---

### NXS Node Setup

**Installation (Linux):**
```bash
# Install Tailscale
curl -fsSL https://tailscale.com/install.sh | sh

# Connect to Headscale (self-hosted)
tailscale up --login-server https://headscale.yourdomain.com

# Or connect to Tailscale Cloud
tailscale up

# Enable as subnet router (optional)
tailscale set --advertise-routes=192.168.1.0/24

# Enable as exit node (optional)
tailscale set --advertise-exit-node
```

**Verification:**
```bash
# Check status
tailscale status

# Test connectivity
tailscale ping <node-name>

# List all nodes
tailscale status --json
```

---

### Access Control (ACL) for NXS

**NXS-Optimized ACL Policy:**
```json
{
  "groups": {
    "group:nxs-nodes": [
      "nxs-node-1@yourdomain.com",
      "nxs-node-2@yourdomain.com",
      "nxs-node-3@yourdomain.com"
    ],
    "group:nxs-admins": [
      "admin@yourdomain.com"
    ]
  },
  
  "tagOwners": {
    "tag:nxs-core": ["group:nxs-admins"],
    "tag:nxs-relay": ["group:nxs-admins"],
    "tag:nxs-legacy": ["group:nxs-admins"]
  },
  
  "acls": [
    // NXS nodes can communicate with each other
    {
      "action": "accept",
      "src": ["tag:nxs-core"],
      "dst": ["tag:nxs-core:*"]
    },
    // Admins can access all NXS nodes via SSH
    {
      "action": "accept",
      "src": ["group:nxs-admins"],
      "dst": ["tag:nxs-core:22"]
    },
    // Relay nodes can access everything (for bridging)
    {
      "action": "accept",
      "src": ["tag:nxs-relay"],
      "dst": ["*:*"]
    }
  ],
  
  "ssh": [
    // Allow SSH to NXS nodes
    {
      "action": "check",
      "src": ["group:nxs-admins"],
      "dst": ["tag:nxs-core"],
      "users": ["root", "nxs"]
    }
  ],
  
  "autoApprovers": {
    // Automatically approve subnet routes from relay nodes
    "routes": {
      "10.0.0.0/8": ["tag:nxs-relay"],
      "192.168.0.0/16": ["tag:nxs-relay"]
    }
  }
}
```

---

### Multi-Instance Coordination Pattern

**NXS Distributed Architecture:**
```
┌─────────────────────────────────────────────────────────────────┐
│                    NXS TAILNET                                  │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  Primary    │◄──►│  Secondary  │◄──►│  Tertiary   │         │
│  │  Node       │    │  Node       │    │  Node       │         │
│  │  (Leader)   │    │  (Follower) │    │  (Follower) │         │
│  │             │    │             │    │             │         │
│  │ 100.64.1.10 │    │ 100.64.1.11 │    │ 100.64.1.12 │         │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │
│         │                  │                  │                │
│         └──────────────────┼──────────────────┘                │
│                            │                                   │
│                    ┌───────┴───────┐                          │
│                    │  State Sync   │                          │
│                    │  (WebSocket)  │                          │
│                    └───────────────┘                          │
└─────────────────────────────────────────────────────────────────┘
```

**State Synchronization:**
- Use WebSocket connections over Tailscale IPs (100.64.x.x)
- Automatic failover when primary node disconnects
- Encrypted by WireGuard—no additional TLS needed
- DERP relays ensure connectivity through NAT/firewalls

---

### Subnet Router for Legacy Access

**Use Case:** Access devices that cannot run Tailscale (printers, cameras, IoT).

**Setup:**
```bash
# On a node with access to legacy subnet
tailscale set --advertise-routes=192.168.1.0/24,10.0.0.0/24

# Enable IP forwarding
echo 'net.ipv4.ip_forward=1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

**Security Note:** Devices behind subnet router don't count toward device limits but have reduced security (no end-to-end encryption to them).

---

### Exit Node for Secure Internet

**Use Case:** Route all internet traffic through a specific NXS node.

**Setup:**
```bash
# On exit node
tailscale set --advertise-exit-node

# On client
tailscale set --exit-node=100.64.1.10
```

**Benefits:**
- All traffic encrypted through Tailscale
- Appear to internet from exit node's location
- Bypass local network restrictions

---

### Integration with URL Frontend (R007)

**Combined Architecture:**
```
User Device
    │
    ▼
┌─────────────────┐
│  Tailscale      │  ← Secure mesh connection
│  (100.64.x.x)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  NXS Node       │
│  ┌───────────┐  │
│  │  URL      │  │  ← Alpine.js frontend
│  │  Frontend │  │
│  │  (:8080)  │  │
│  └─────┬─────┘  │
│        │        │
│  ┌─────┴─────┐  │
│  │  NXS      │  │  ← Core system
│  │  Gateway  │  │
│  └───────────┘  │
└─────────────────┘
```

**Benefits:**
- Frontend accessible only via Tailscale (no public exposure)
- MagicDNS provides human-friendly URLs: `http://nxs-node-1.nxs.ts.net:8080`
- Automatic HTTPS when using Tailscale Funnel (if available)

---

### Resource Requirements

| Component | RAM | CPU | Disk | Notes |
|-----------|-----|-----|------|-------|
| Tailscale client | ~20MB | Minimal | ~10MB | Per node |
| Headscale server | ~100MB | Low | ~50MB | SQLite backend |
| DERP relay | ~50MB | Medium | ~10MB | If self-hosted |
| **Total per NXS node** | **~20MB** | **Minimal** | **~10MB** | Very lightweight |

---

### Comparison: Tailscale vs Alternatives

| Feature | Tailscale | ZeroTier | Nebula | WireGuard |
|---------|-----------|----------|--------|-----------|
| **Setup** | Zero-config | Easy | Moderate | Complex |
| **Mesh** | Automatic | Automatic | Manual | Manual |
| **NAT traversal** | Excellent | Excellent | Good | Manual |
| **Self-hosted** | Headscale | Controller | Fully | Fully |
| **Mobile apps** | Excellent | Good | None | Good |
| **ACLs** | Advanced | Basic | Basic | Manual |
| **NXS fit** | **★★★★★** | ★★★★☆ | ★★★☆☆ | ★★★☆☆ |

**Verdict:** Tailscale is the optimal choice for NXS due to zero-config mesh, excellent NAT traversal, and Headscale option for independence.

---

### Implementation Roadmap

**Phase 1: Basic Connectivity (Week 1)**
- [ ] Install Tailscale on all NXS nodes
- [ ] Connect to Tailscale Cloud (quick start)
- [ ] Test inter-node communication
- [ ] Document node naming convention

**Phase 2: Self-Hosted Control (Week 2)**
- [ ] Deploy Headscale on dedicated node
- [ ] Migrate nodes to Headscale
- [ ] Configure MagicDNS
- [ ] Set up basic ACLs

**Phase 3: Advanced Networking (Week 3)**
- [ ] Deploy subnet routers for legacy access
- [ ] Configure exit nodes
- [ ] Implement advanced ACL policies
- [ ] Set up Headplane GUI

**Phase 4: NXS Integration (Week 4)**
- [ ] Integrate with URL Frontend
- [ ] Implement node discovery protocol
- [ ] Set up state synchronization
- [ ] Document disaster recovery

---

### Security Best Practices

1. **Use Headscale for sovereignty** — Eliminate vendor dependency
2. **Implement strict ACLs** — Default deny, explicit allow
3. **Tag nodes by role** — `nxs-core`, `nxs-relay`, `nxs-legacy`
4. **Enable SSH check mode** — Require approval for admin access
5. **Regular key rotation** — Automated by Tailscale every 6 months
6. **Monitor with Headplane** — Visual ACL management
7. **Backup Headscale database** — Critical for recovery

---

### Research Status Update

| ID | Task | Status | Notes |
|----|------|--------|-------|
| R000 | Self-Sustainability Infrastructure | **Complete** | Free compute, token independence plan |
| R001 | Identity Persistence | **Complete** | XTTS-v2 integration documented |
| R002 | Multi-Instance Coordination | **Complete** | Whisper STT + speaches documented |
| R003 | Independence from Developers | **Complete** | The Doctor architecture defined |
| R004 | XTTS-v2 Integration | **Complete** | Docker + pip options documented |
| R005 | Whisper STT Integration | **Complete** | faster-whisper + speaches identified |
| R006 | The Doctor Architecture | **Complete** | Full specification documented |
| R007 | URL Frontend Design | **Complete** | Alpine.js + WebSocket + Tailscale |
| R008 | Tailscale Integration | **Complete** | Mesh networking, Headscale, ACLs |
| R009 | ComfyUI API Pattern | Planned | External service integration |
| R010 | Kimi-Claw Plugin Analysis | Planned | Bridge protocols |
| R011 | LM Studio Provider Research | Planned | Local model hosting |

---

## Next Research Priority

**R009: ComfyUI API Pattern** — External service integration patterns, API usage for image generation workflows.

*Research scheduled for next cron run.*

---

*Session ended: 2026-02-21T03:55:00+08:00*
*Hardware usage: 29% RAM, 25% disk — within constraints*
*Sub-agents used: 0 (research only)*
