# NXS Research Log

## Research Session: 2026-02-22 (Midday - Continuous Improvement)

### Cron-Triggered Research Review

**Timestamp:** 2026-02-22T11:57:00+08:00

---

## Executive Summary

Reviewed ongoing research tasks (R000-R015). Selected 3 under-explored tasks for deeper analysis:
- **R007** - URL Frontend Design (High Priority, minimal documented refinements)
- **R004/R005** - Voice Pipeline Integration (High Priority, technology selected but integration patterns missing)
- **R015** - Non-LLM Mundane Task Scripts (Medium Priority, needs architecture specification)

**Improvements Found:** 10 refinements across 3 tasks
**Files Updated:** 2 (this log, RESEARCH-TASK-INDEX.md)

---

## Task R007: URL Frontend Design - Refinements

### Current Status
R007 covers web interface for direct access without chat channels. Alpine.js selected as framework but lacks concrete design specifications, component architecture, and security model.

### Refinements Identified

#### 1. **Component Architecture Specification** (New)
**Gap Found:** No defined component hierarchy or state management approach for Alpine.js frontend.

**Refinement:** Define 3-tier component architecture:
```
Presentation Layer (Alpine.js Components):
├── ChatInterface      # Main conversation view
├── MessageThread      # Scrollable message list
├── InputComposer      # Text/voice input area
├── StatusIndicator    # Connection/resource status
├── SettingsPanel      # Configuration UI
└── VoiceControls      # TTS/STT toggle, voice selection

State Layer (Alpine.js Stores):
├── sessionStore       # Current session, messages, context
├── configStore        # User preferences, API keys
├── statusStore        # Connection, resource metrics
└── voiceStore         # Voice settings, TTS queue

Service Layer (JS Modules):
├── apiClient.js       # HTTP/WebSocket to NXS backend
├── voiceService.js    # XTTS/Whisper integration
├── storageService.js  # localStorage/indexedDB wrapper
└── syncService.js     # Cross-tab state synchronization
```

**State Management Pattern:**
- Use Alpine.js `$store` for global state
- Component-level `x-data` for local UI state
- Immutable state updates with automatic persistence
- Optimistic UI updates with rollback on failure

**Benefit:** Clear separation of concerns; predictable state flow; testable architecture.

#### 2. **Progressive Web App (PWA) Specification** (New)
**Gap Found:** No offline capability or mobile-optimized experience defined.

**Refinement:** Design PWA capabilities for frontend:
| Feature | Implementation | Priority |
|---------|---------------|----------|
| Service Worker | Cache static assets, offline message queue | High |
| Web App Manifest | Installable on mobile/desktop | High |
| Background Sync | Queue messages when offline, sync on reconnect | Medium |
| Push Notifications | Alert for important messages when tab closed | Medium |
| Responsive Design | Mobile-first, tablet, desktop breakpoints | High |

**Offline Behavior:**
- Messages composed offline queued in IndexedDB
- Sent automatically when connection restored
- Visual indicator for "sending..." / "sent" / "failed"
- Cached conversation history available offline

**Benefit:** Works without constant connectivity; native-app-like experience; mobile-optimized.

#### 3. **Security Model for URL Frontend** (New)
**Gap Found:** No authentication or authorization model defined for web access.

**Refinement:** Design 3-tier security model:
```
Tier 1: Local-Only (Default)
- Bind to localhost/127.0.0.1 only
- No authentication required (physical access = trust)
- Suitable for: Single-user, local machine

Tier 2: Tailscale-Only
- Bind to Tailscale IP (100.x.x.x)
- mTLS with Tailscale-generated certificates
- No additional auth (Tailscale identity = authorization)
- Suitable for: Multi-device, private mesh

Tier 3: Public-Facing (Optional)
- Bind to 0.0.0.0 with reverse proxy
- JWT-based authentication
- Rate limiting, IP allowlisting
- Suitable for: Remote access without Tailscale
```

**Authentication Flow (Tier 3):**
1. User requests access → Login page
2. Password + TOTP verification
3. JWT issued (24h expiry, refresh token 7d)
4. WebSocket connection with JWT in subprotocol
5. Token refresh automatic before expiry

**Benefit:** Secure by default; flexible deployment options; defense in depth.

#### 4. **Real-Time Protocol Design** (New)
**Gap Found:** No specification for WebSocket message protocol between frontend and NXS.

**Refinement:** Define JSON-based protocol with message types:
```typescript
// Message envelope
interface NXSMessage {
  id: string;           // UUID for correlation
  type: MessageType;    // Enum of message types
  timestamp: ISO8601;   // Client timestamp
  payload: unknown;     // Type-specific data
}

// Message types
type MessageType =
  | 'chat.send'         // User message to NXS
  | 'chat.receive'      // NXS response
  | 'chat.stream'       // Streaming response chunk
  | 'voice.tts'         // Request TTS
  | 'voice.stt'         // STT result
  | 'system.status'     // Resource/connection status
  | 'system.config'     // Configuration update
  | 'session.sync'      // Session state synchronization
  | 'file.upload'       // File upload request
  | 'file.download';    // File download response
```

**Streaming Protocol:**
- Server-sent events (SSE) for simple streaming
- WebSocket binary frames for voice streaming
- Backpressure handling (client can pause/resume)

**Benefit:** Structured communication; extensible for new features; clear error handling.

---

## Task R004/R005: Voice Pipeline Integration - Refinements

### Current Status
R004 (XTTS-v2) and R005 (Whisper) have technology selections but lack integration architecture, audio pipeline design, and resource management strategy.

### Refinements Identified

#### 5. **Unified Audio Pipeline Architecture** (New)
**Gap Found:** No specification for how XTTS and Whisper integrate with NXS core and frontend.

**Refinement:** Design 4-stage audio pipeline:
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Capture   │───→│  Process    │───→│   Queue     │───→│   Output    │
│             │    │             │    │             │    │             │
│ - Mic input │    │ - Whisper   │    │ - Priority  │    │ - Speakers  │
│ - File upload│   │ - XTTS      │    │ - Buffer    │    │ - File save │
│ - Stream in │    │ - Format    │    │ - Flow ctl  │    │ - Stream out│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
     STT Path            ↑↓                  ↑↓               TTS Path
```

**Pipeline Characteristics:**
- **Bidirectional:** Can process STT and TTS concurrently
- **Stream-capable:** Voice streaming for real-time conversation
- **Resource-aware:** Pauses processing if >75% resource usage
- **Interruptible:** User can stop TTS playback mid-sentence

**Benefit:** Unified audio handling; efficient resource use; smooth user experience.

#### 6. **Voice Activity Detection (VAD) Integration** (New)
**Gap Found:** No strategy for detecting when user starts/stops speaking for hands-free operation.

**Refinement:** Integrate Silero VAD for speech detection:
```
VAD States:
├── IDLE        # Waiting for speech
├── DETECTING   # Possible speech detected (debounce)
├── SPEAKING    # Confirmed speech, recording
└── SILENCE     # Speech ended, process buffer
```

**Configuration:**
| Parameter | Default | Description |
|-----------|---------|-------------|
| threshold | 0.5 | Probability threshold for speech |
| min_speech_duration | 250ms | Minimum to consider valid |
| min_silence_duration | 500ms | Silence before processing |
| max_recording_duration | 30s | Hard limit to prevent runaway |

**Integration:**
- Web Audio API → VAD → Whisper (only process speech segments)
- Reduces Whisper compute by ~40% (no processing silence)
- Enables push-to-talk alternative (always-listening mode)

**Benefit:** Hands-free operation; reduced compute waste; natural conversation flow.

#### 7. **Voice Model Resource Management** (New)
**Gap Found:** XTTS (~1GB) and Whisper (~244MB) models consume significant RAM. No unload strategy defined.

**Refinement:** Design tiered model loading strategy:
```
Loading Tiers:
├── HOT     # Model in RAM, ready for instant use
│   └── Keep loaded if voice used in last 5 minutes
├── WARM    # Model on disk, can load in <2 seconds
│   └── Keep cached if voice used in last 30 minutes  
└── COLD    # Must download before use
    └── Delete after 24 hours of non-use
```

**Resource Thresholds:**
- If RAM >70%: Unload HOT → WARM for least-recently-used model
- If RAM >80%: Unload all to WARM, queue voice requests
- If disk >75%: Delete COLD models, keep only metadata

**Preloading Strategy:**
- Predictive: Preload voice model if user opens voice settings
- Explicit: User can "pin" a model to stay HOT
- Lazy: Default on-demand loading

**Benefit:** Responsive voice interaction while respecting 75% resource limit.

#### 8. **Voice Quality Fallback Chain** (New)
**Gap Found:** No graceful degradation if XTTS fails or is too slow.

**Refinement:** Define 3-tier voice quality fallback:
```
Tier 1: XTTS-v2 (Highest Quality)
- Use when: Resources available, <5s TTS queue
- Latency: 1-3s for short phrases
- Quality: Natural, voice cloning capable

Tier 2: Piper (Fast Fallback)
- Use when: XTTS queue >5s, or XTTS failed
- Latency: <500ms
- Quality: Good, limited voices

Tier 3: System TTS (Emergency)
- Use when: Both above failed, or critical alert
- Latency: Immediate
- Quality: Robotic but intelligible
```

**Automatic Selection:**
- User can set "preferred" and "minimum acceptable" quality
- NXS automatically selects best available within constraints
- Alerts user if quality degraded due to resource constraints

**Benefit:** Always functional voice output; graceful degradation; user control.

---

## Task R015: Non-LLM Mundane Task Scripts - Refinements

### Current Status
R015 covers self-contained scripts for tasks not requiring LLM. Has examples and integration patterns but lacks formal architecture, script registry specification, and security sandbox design.

### Refinements Identified

#### 9. **Script Registry and Discovery Protocol** (New)
**Gap Found:** No specification for how scripts register capabilities or how NXS discovers available scripts.

**Refinement:** Design metadata-driven script registry:
```yaml
# Script metadata header (required in first 50 lines)
# @nxs-script
# name: log-rotator
# version: 1.0.0
# description: Rotate and compress log files
# author: Tenet Ashmier Manju
# capabilities:
#   - filesystem.read
#   - filesystem.write
#   - subprocess.exec
# triggers:
#   - type: cron
#     schedule: "0 0 * * *"  # Daily at midnight
#   - type: event
#     event: "disk.full"
#   - type: http
#     path: "/api/scripts/log-rotator/run"
# inputs:
#   - name: log_dir
#     type: path
#     required: true
#     description: "Directory containing logs"
#   - name: max_age_days
#     type: number
#     default: 7
# outputs:
#   - name: files_rotated
#     type: number
#     description: "Count of files rotated"
# resources:
#   max_memory_mb: 100
#   max_duration_seconds: 60
#   cpu_priority: low
```

**Discovery Process:**
1. Scan `~/.openclaw/scripts/` on startup
2. Parse metadata headers from each `.js` file
3. Validate: required fields present, capabilities known
4. Register in internal script registry
5. Set up triggers (cron, watchers, HTTP routes)

**Benefit:** Self-documenting scripts; automatic discovery; capability-based security.

#### 10. **Script Sandbox and Permission Model** (New)
**Gap Found:** Scripts have filesystem and subprocess access. No sandboxing or permission system defined.

**Refinement:** Design capability-based sandbox:
```
Capability Levels:
├── NONE      # Pure computation, no external access
├── READ      # Read-only filesystem access
├── WRITE     # Read-write to specific directories
├── NETWORK   # HTTP/HTTPS requests only
├── SUBPROCESS # Spawn child processes
└── SYSTEM    # Full system access (dangerous)
```

**Sandbox Implementation (Node.js vm2 alternative):**
```javascript
// Use Node.js built-in vm with context isolation
const vm = require('node:vm');

const sandbox = {
  // Explicitly allowed capabilities only
  console: restrictedConsole,
  fs: capabilities.includes('READ') ? restrictedFs : undefined,
  fetch: capabilities.includes('NETWORK') ? restrictedFetch : undefined,
  
  // NXS-provided utilities
  nxs: {
    log: (level, message) => { /* ... */ },
    getConfig: (key) => { /* ... */ },
    emitEvent: (name, data) => { /* ... */ }
  },
  
  // No access to: process, require (unrestricted), global
};

vm.runInNewContext(scriptCode, sandbox, {
  timeout: maxDurationSeconds * 1000,
  displayErrors: true,
});
```

**Permission Escalation:**
- Scripts can request additional capabilities at runtime
- User prompted for approval (or auto-approved if in trust list)
- All capability usage logged for audit

**Benefit:** Secure script execution; principle of least privilege; audit trail.

---

## Cross-Cutting Improvements

### R007 + R004/R005 Integration
Voice controls in frontend need seamless integration with backend voice pipeline:
- Frontend: Voice settings UI, push-to-talk button, voice activity indicator
- Protocol: WebSocket binary frames for audio streaming
- Backend: Unified audio pipeline with VAD, XTTS/Whisper, resource management

### R015 + R003 Integration
Non-LLM scripts support independence (R003) by handling routine tasks without LLM costs:
- Self-healing scripts run autonomously (Tier 1 permission)
- Health reporting scripts run on schedule
- Git sync scripts maintain identity persistence

---

## Updated Task Status

| Task | Previous Improvements | New Improvements | Total |
|------|----------------------|------------------|-------|
| R013 | 6 | - | 6 |
| R012 | 3 | - | 3 |
| R006 | 4 | - | 4 |
| R008 | 3 | - | 3 |
| R002 | 4 | - | 4 |
| R000 | 4 | - | 4 |
| R001 | 3 | - | 3 |
| R003 | 4 | - | 4 |
| **R007** | **0** | **4** | **4** |
| **R004/R005** | **0** | **4** | **4** |
| **R015** | **2** | **2** | **4** |
| Meta | 2 | - | 2 |

**Total Refinements Documented:** 42 improvements across 11 research tasks

---

## Files Updated

1. `/opt/development/memory/2026-02-22.md` — This research log (appended)
2. `/opt/development/RESEARCH-TASK-INDEX.md` — Added R007, R004/R005, R015 refinements

---

## Backup Status

Research results will be backed up to GitHub via API after session completion.

---

*Session completed: 2026-02-22T12:08:00+08:00*

**Researcher:** Tenet Ashmier Manju (NXS Development Agent)  
**Hardware Usage:** 38% RAM, 26% disk (within limits)  
**Sub-agents Used:** 0/2

**Refinements Documented:** 10 improvements across 3 research tasks  
**Status:** Continuous improvement mode — all tasks remain Ongoing
